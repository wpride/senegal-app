<?xml version="1.0" encoding="UTF-8" ?>
<h:html xmlns:h="http://www.w3.org/1999/xhtml" xmlns:orx="http://openrosa.org/jr/xforms" xmlns="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:jr="http://openrosa.org/javarosa">
  <h:head>
    <h:title>senegal operateur form</h:title>
    <model>
      <instance>
        <data xmlns:jrm="http://dev.commcarehq.org/jr/xforms" xmlns="http://openrosa.org/formdesigner/7330597b92db84b1a33c7596bb7b1813502879be" uiVersion="1" version="1" name="Bon de commande-livraison Real">

          <products index="">
            <screen1>
              <disp_old_stock_total />
              <disp_old_stock_pps />

              <outside_receipts_amt />
              <loss_amt />
              
              <pps_stock /> <!-- interim value that can go negative -->
              <billed_consumption />
            </screen1>
            <screen2>
            </screen2>

            <outside_receipts>
              <transfer xmlns="http://commtrack.org/section_report" dest="" type="other" date="">
                <entry id="">
                  <value section-id="stock" quantity=""/>
                  <value section-id="stock-pps" quantity=""/>
                </entry >
              </transfer>
            </outside_receipts>
            <losses>
              <transfer xmlns="http://commtrack.org/section_report" src="" type="loss" date="">
                <entry id="">
                  <value section-id="stock" quantity=""/>
                  <value section-id="stock-pps" quantity=""/>
                </entry >
              </transfer>
            </losses>
            <balance xmlns="http://commtrack.org/stock_report" entity-id="" date="">
              <entry id="">
                <value section-id="stock" quantity="" />
                <value section-id="stock-pps" quantity="" />
              </entry>
            </balance>
            <top_up>
              <transfer xmlns="http://commtrack.org/section_report" dest="" date="">
                <entry id="">
                  <value section-id="stock" quantity=""/>
                </entry >
              </transfer>
            </top_up>
            
          </products>
          <products_review index="">
            <screen3>
            </screen3>
          </products_review>
          
          <product_ix_1 />
          <product_ix_2 />                  
        </data>
      </instance>
      <instance id="commcaresession" src="jr://instance/session" />
      <instance id="products" src="jr://fixture/commtrack:products" />
      <instance id="ledger" src="jr://instance/ledgerdb" />

      <bind nodeset="/data/product_ix_1" calculate="count(/data/products)"/>
      <bind nodeset="/data/product_ix_2" calculate="count(/data/products_review)"/>
      <setvalue event="jr-insert" ref="/data/products/@index" value="int(/data/product_ix_1)"/>
      <setvalue event="jr-insert" ref="/data/products_review/@index" value="int(/data/product_ix_2)"/>

      <setvalue event="jr-insert" ref="/data/products/balance/@entity-id" value="instance('commcaresession')/session/data/case_id" />
      <setvalue event="jr-insert" ref="/data/products/outside_receipts/transfer/@dest" value="instance('commcaresession')/session/data/case_id" />
      <setvalue event="jr-insert" ref="/data/products/top_up/transfer/@dest" value="instance('commcaresession')/session/data/case_id" />
      <setvalue event="jr-insert" ref="/data/products/losses/transfer/@src" value="instance('commcaresession')/session/data/case_id" />
      <setvalue event="jr-insert" ref="/data/products/balance/entry/@id" value="instance('products')/products/product[index()=../@index]/@id" />
      <setvalue event="jr-insert" ref="/data/products/outside_receipts/transfer/entry/@id" value="instance('products')/products/product[index()=../@index]/@id" />
      <setvalue event="jr-insert" ref="/data/products/losses/transfer/entry/@id" value="instance('products')/products/product[index()=../@index]/@id" />
      <setvalue event="jr-insert" ref="/data/products/top_up/transfer/entry/@id" value="instance('products')/products/product[index()=../@index]/@id" />
      
      <!-- note: these binds duplicate the transfer for both the 'stock' and 'stock-pps' sections -->
      <bind nodeset="/data/products/outside_receipts/transfer/entry/value/@quantity" calculate="/data/products/screen1/outside_receipts_amt" />
      <bind nodeset="/data/products/losses/transfer/entry/value/@quantity" calculate="/data/products/screen1/losses_amt" />
      
      <bind nodeset="/data/products/screen1/pps_stock" calculate="instance('ledger')/ledgerdb/ledger[@entity-id=instance('commcaresession')/session/data/case_id]/section[@section-id='stock-pps']/entry[@id=instance('products')/products/product[index()=../@index]/@id] + /data/products/balance/entry/value[@section-id='stock']/@quantity - instance('ledger')/ledgerdb/ledger[@entity-id=instance('commcaresession')/session/data/case_id]/section[@section-id='stock']/entry[@id=instance('products')/products/product[index()=../@index]/@id]" />
      <bind nodeset="/data/products/screen1/billed_consumption" calculate="max(-../pps_stock, 0)" />
      <bind nodeset="/data/products/balance/entry/value[@section-id='stock-pps']/@quantity" calculate="max(/data/products/screen1/pps_stock, 0)" />

    </model>
  </h:head>
  <h:body>

    <!-- add q: visit is for which month? -->
    <repeat nodeset="/data/products" jr:count="count(instance('products')/products/product)">
      <group ref="/data/products/screen1" appearance="field-list">
        <label><output value="[product name]"/></label>

        <trigger ref="/data/products/screen1/disp_old_stock_total">
          <label>Total SOH after last visit: <output value="instance('ledger')/ledgerdb/ledger[@entity-id=instance('commcaresession')/session/data/case_id]/section[@section-id='stock']/entry[@id=instance('products')/products/product[index()=../@index]/@id]" /></label>
        </trigger>
        <trigger ref="/data/products/screen1/disp_old_stock_total">
          <label>Of which portion is the PPS's own stash: <output value="instance('ledger')/ledgerdb/ledger[@entity-id=instance('commcaresession')/session/data/case_id]/section[@section-id='stock-pps']/entry[@id=instance('products')/products/product[index()=../@index]/@id]" /></label>
        </trigger>

        <input ref="/data/products/balance/entry/value[@section-id='stock']/@quantity">
          <label>Current total stock</label>
        </input>
        <input ref="/data/products/screen1/outside_receipts_amt">
          <label>Receipts from outside sources</label>
        </input>
        <input ref="/data/products/screen1/loss_amt">
          <label>Losses/adjustments</label>
        </input>

      </group>
      <group ref="/data/products/screen2" appearance="field-list">
        <label><output value="[product name]"/></label>

        <!-- TODO
             display: ideal stock (3.5*amc)
             did you deliver this much?
             if no, how much delivered?
        -->

        <!-- add q: lot number/expiration date(s) -->

      </group>
    </repeat>

    <repeat nodeset="/data/products_review" jr:count="count(instance('products')/products/product)">
      <group ref="/data/products/screen3" appearance="field-list">
        <label><output value="[product name]"/></label>
        <!-- TODO: just show summary stuff here -->
      </group>
    </repeat>


  </h:body>
</h:html>